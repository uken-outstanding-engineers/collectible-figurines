<div class="chat-container">
  <aside class="users-list">
    <div class="users-header">Wiadomości</div>
    <ul>
      <li
        *ngFor="let user of users"
        (click)="selectUser(user)"
        [class.selected]="selectedUser?.id === user.id"
      >
        <img
          *ngIf="user.avatarUrl; else defaultAvatar"
          [src]="apiUrl + user?.avatarUrl"
          alt="{{ user.username }}"
          class="avatar"
        />
        <ng-template #defaultAvatar>
          <img src="avatar-images/default_avatar.jpg" alt="{{ user.username || 'Użytkownik' }}" class="avatar">
        </ng-template>
        <span>{{ user.username }}</span>
      </li>
    </ul>
  </aside>

  <section *ngIf="selectedUser" class="messages-panel">

    <div class="messages-header header-with-menu">
      <div class="username-wrapper">
        <a [routerLink]="['/profile', selectedUser.id]">
          <strong>{{ selectedUser.username }}</strong>
        </a>
      </div>

      <div class="menu-wrapper" #menuWrapper (click)="toggleMenu()" tabindex="0">
        <span class="menu-dots">⋯</span>
        <ul class="menu-dropdown" *ngIf="menuOpen">
          <li (click)="openTradeBox()" *ngIf="!isTradeBoxOpen;" >Zaproponuj wymianę</li>
          <li (click)="closeTradeBox()" *ngIf="isTradeBoxOpen;" >Wróc do wiadomości</li>
        </ul>
      </div>
    </div>

    <ng-container *ngIf="!isTradeBoxOpen; else tradeView">
    <div class="messages-list">
      <div
        *ngFor="let msg of messages"
        [ngClass]="{
          'message': true,
          'sent': msg.sender.id === loggedInUserId,
          'received': msg.sender.id !== loggedInUserId
        }"
      >
        <div class="message-content">{{ msg.content }}</div>
        <div class="message-date">{{ msg.date | date:'yyyy-MM-dd HH:mm' }}</div>
      </div>
      <div #bottom></div>
    </div>
  </ng-container>

  <ng-template #tradeView>
    <div class="messages-list trade-box">
      <h3>Propozycja wymiany</h3>

      <div class="trade-section">
        <label>Twoje figurki do wymiany:</label>
        <select [(ngModel)]="selectedOfferFigureId">
          <option [value]="null" disabled>Wybierz figurkę</option>
          <option *ngFor="let fig of figures" [ngValue]="fig.id">{{ fig.name }}</option>
        </select>
        <button (click)="addOfferFigure()">Dodaj</button>
        <div class="figures-list">
          <span *ngFor="let fig of offerFigures" (click)="removeOfferFigure(fig)" class="figure-chip">
            {{ fig.name }} ✕
          </span>
        </div>
      </div>

      <div class="trade-section">
        <label>Figurki do odbioru:</label>
        <select [(ngModel)]="selectedRequestFigureId">
          <option [value]="null" disabled>Wybierz figurkę</option>
          <option *ngFor="let fig of figures" [ngValue]="fig.id">{{ fig.name }}</option>
        </select>
        <button (click)="addRequestFigure()">Dodaj</button>
        <div class="figures-list">
          <span *ngFor="let fig of requestFigures" (click)="removeRequestFigure(fig)" class="figure-chip">
            {{ fig.name }} ✕
          </span>
        </div>
      </div>

      <div class="trade-preview">
        <h4>Podgląd propozycji:</h4>
        <div class="preview-section">
          <strong>Twoje figurki:</strong>
          <ul><li *ngFor="let fig of offerFigures">{{ fig.name }}</li></ul>
        </div>
        <div class="preview-section">
          <strong>Figurki do odbioru:</strong>
          <ul><li *ngFor="let fig of requestFigures">{{ fig.name }}</li></ul>
        </div>
      </div>

      <button class="send-trade-btn" (click)="confirmTrade()">Wyślij propozycję</button>
      <button class="cancel-trade-btn" (click)="closeTradeBox()">Anuluj</button>
    </div>
  </ng-template>


    <form *ngIf="!isTradeBoxOpen;" class="message-form" (submit)="sendMessage()" #messageForm="ngForm">
      <input
        type="text"
        name="content"
        [(ngModel)]="newMessageContent"
        placeholder="Napisz wiadomość..."
        required
        class="message-input"
      />
      <button type="submit" [disabled]="!newMessageContent.trim()" class="send-button">
        Wyślij
      </button>
    </form>
  </section>

  <ng-template #noSelection>
    <div class="no-selection">Wybierz użytkownika z listy, aby zobaczyć wiadomości</div>
  </ng-template>
</div>
